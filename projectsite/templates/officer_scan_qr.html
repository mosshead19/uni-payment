{% extends "base.html" %}

{% block title %}QR Code Scanner - UniPay{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
    #qr-reader {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }
    #qr-reader__dashboard_section_csr {
        text-align: center;
    }
    .scanner-container {
        background: var(--bg-secondary);
        border-radius: 1rem;
        padding: 2rem;
        border: 1px solid var(--border-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center py-5">
    <div class="col-md-10 col-lg-8">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-primary text-white py-4">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-20 rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                        <i class="fas fa-qrcode fa-lg text-white"></i>
                    </div>
                    <div>
                        <h3 class="mb-0 fw-bold">QR Code Scanner</h3>
                        <small class="opacity-75">Scan student QR code to process payment</small>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <p class="lead text-muted mb-4">
                        <i class="fas fa-camera me-2 text-primary"></i>
                        Point your camera at the student's QR code
                    </p>
                </div>
                
                <div class="scanner-container mb-4">
                    <div id="qr-reader"></div>
                </div>
                
                <div id="qr-reader-results" class="alert alert-info shadow-sm" style="display: none;">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <strong>Processing QR code...</strong> Please wait.
                </div>
                
                <div id="error-message" class="alert alert-danger shadow-sm" style="display: none;"></div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                    <a href="{% url 'officer_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let html5QrcodeScanner = null;

function onScanSuccess(decodedText, decodedResult) {
    console.log("QR Code scanned successfully:", decodedText);
    
    // Keep scanner running - don't stop the camera feed
    // The camera will continue to work until the user navigates away
    
    // Show processing message
    document.getElementById('qr-reader-results').style.display = 'block';
    document.getElementById('error-message').style.display = 'none';
    
    // Parse QR data
    const parts = decodedText.trim().split('|');
    console.log("Parsed QR parts:", parts);
    
    if (parts.length === 3 && parts[0] === 'PAYMENT_REQUEST') {
        const requestId = parts[1].trim();
        const signature = parts[2].trim();
        
        console.log("Processing payment request:", requestId, "with signature:", signature);
        
        // Redirect to process payment - this will automatically stop the scanner when user navigates away
        const url = `/officer/process/${requestId}/${signature}/`;
        console.log("Redirecting to:", url);
        window.location.href = url;
    } else {
        console.warn("Invalid QR code format. Parts:", parts);
        document.getElementById('qr-reader-results').style.display = 'none';
        document.getElementById('error-message').innerHTML = 
            '<i class="fas fa-exclamation-triangle me-2"></i><strong>Invalid QR Code:</strong> This QR code is not a valid payment request. Scanned: ' + decodedText.substring(0, 50) + '...';
        document.getElementById('error-message').style.display = 'block';
        
        // Keep scanning - camera continues to run
        // The scanner will automatically continue scanning after showing the error
        // User can try scanning again immediately
    }
}

function onScanFailure(error) {
    // Ignore scan failures
}

function startScanner() {
    console.log("Starting QR scanner...");
    
    // Clear any previous scanner instance
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.stop().then(() => {
                console.log("Previous scanner stopped");
                html5QrcodeScanner = null;
                initializeNewScanner();
            }).catch(() => {
                console.log("Previous scanner was already stopped");
                html5QrcodeScanner = null;
                initializeNewScanner();
            });
        } catch (e) {
            console.error("Error stopping previous scanner:", e);
            html5QrcodeScanner = null;
            initializeNewScanner();
        }
    } else {
        initializeNewScanner();
    }
}

function initializeNewScanner() {
    console.log("Initializing new scanner...");
    
    // Show scanner container
    document.getElementById('qr-reader').style.display = 'block';
    document.getElementById('error-message').style.display = 'none';
    document.getElementById('qr-reader-results').style.display = 'none';
    
    // Check if Html5Qrcode is available
    if (typeof Html5Qrcode === 'undefined') {
        console.error("Html5Qrcode library not loaded!");
        handleScannerError(new Error("Html5Qrcode library not loaded. Please refresh the page."));
        return;
    }
    
    try {
        const readerId = 'qr-reader';
        html5QrcodeScanner = new Html5Qrcode(readerId);
        console.log("Scanner instance created");
        
        // Start scanner with proper Promise handling
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            onScanSuccess,
            onScanFailure
        ).then(() => {
            console.log("✓ Scanner started successfully");
        }).catch(err => {
            console.error("✗ Scanner start error:", err);
            handleScannerError(err);
        });
    } catch (err) {
        console.error("✗ Scanner creation error:", err);
        handleScannerError(err);
    }
}

function handleScannerError(err) {
    console.error("Scanner error details:", err);
    
    let errorMessage = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Camera Access Error:</strong> ';
    let errorStr = err.toString ? err.toString().toLowerCase() : String(err).toLowerCase();
    
    if (errorStr.includes('notallowederror') || errorStr.includes('permission denied') || errorStr.includes('permission')) {
        errorMessage += '<br><br>Camera access was denied. <strong>Steps to fix:</strong><ul class="text-start mt-2"><li>Refresh the page and click "Allow" when prompted for camera access</li><li>Check browser settings: Settings > Privacy > Camera, ensure this site is allowed</li><li>Try a different browser if this doesn\'t work</li><li>Ensure your device has camera permissions enabled</li></ul>';
    } else if (errorStr.includes('notfounderror') || errorStr.includes('no camera') || errorStr.includes('no mediadevices') || errorStr.includes('device not found')) {
        errorMessage += '<br><br>No camera found on this device. <strong>Please:</strong><ul class="text-start mt-2"><li>Ensure your device has a working camera</li><li>Check that the camera is not in use by another application</li><li>Try restarting your device</li></ul>';
    } else if (errorStr.includes('notreadableerror') || errorStr.includes('not readable') || errorStr.includes('could not start')) {
        errorMessage += '<br><br>Camera is in use or not accessible. <strong>Please:</strong><ul class="text-start mt-2"><li>Close other applications using the camera (Zoom, Teams, Meet, etc.)</li><li>Restart your browser</li><li>Refresh this page</li></ul>';
    } else if (errorStr.includes('https') || errorStr.includes('secure')) {
        errorMessage += '<br><br>This feature requires a secure (HTTPS) connection. Please access this site via HTTPS.';
    } else {
        errorMessage += '<br><br>' + err.message || err;
    }
    
    document.getElementById('error-message').innerHTML = errorMessage;
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('qr-reader').style.display = 'none';
}

// Start scanner when page loads
function waitForHtml5Qrcode() {
    if (typeof Html5Qrcode !== 'undefined') {
        console.log("Html5Qrcode library loaded, starting scanner...");
        startScanner();
    } else {
        console.log("Waiting for Html5Qrcode library to load...");
        setTimeout(waitForHtml5Qrcode, 100);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Content Loaded");
    waitForHtml5Qrcode();
});

// Also start after window load as backup
window.addEventListener('load', function() {
    console.log("Window Load event fired");
    if (typeof Html5Qrcode !== 'undefined') {
        console.log("Html5Qrcode available on window load");
    }
});

// Stop scanner when user leaves the page (navigate away, close tab, etc.)
window.addEventListener('beforeunload', function() {
    if (html5QrcodeScanner) {
        try {
            html5QrcodeScanner.stop().catch(() => {
                // Already stopped, no action needed
            });
            console.log("Scanner stopped on page unload");
        } catch (e) {
            console.error("Error stopping scanner on unload:", e);
        }
    }
});

// Also handle page visibility changes (when user switches tabs)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden, consider stopping the scanner to save resources
        console.log("Page hidden - scanner will continue running in background");
    } else {
        // Page is visible again, camera will continue
        console.log("Page visible again");
    }
});
</script>
{% endblock %}
